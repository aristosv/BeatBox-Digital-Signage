#!/bin/bash

workingdir=/home/pi/digitalsignage

olivetin_config ()
{
sudo bash -c 'cat > /etc/OliveTin/config.yaml' << 'EOL'
ListenAddressSingleHTTPFrontend: 0.0.0.0:1337
checkForUpdates: true
showNewVersions: true
hideNavigation: false
logLevel: "INFO"

actions:

- title: Show Logo
  shell: $workingdir/signage_logo
  icon: "&#129703"

- title: Play Video
  shell: $workingdir/signage_video
  icon: "&#128250"

- title: Play Music
  shell: $workingdir/signage_audio
  icon: "&#128265"

- title: Image Slideshow
  shell: $workingdir/signage_images
  icon: "&#128247"

- title: YouTube Video
  icon: "&#128249"
  shell: echo {{ youtubelink }} | {{ streamordownload }}
  arguments:

   - name: youtubelink
     title: YouTube Link
     type: very_dangerous_raw_string
     default: https://youtu.be/QC8iQqtG0hg

   - name: streamordownload
     title: Stream or Download
     choices:
      - title: Stream
        value: $workingdir/signage_youtube_stream

      - title: Download & Play
        value: $workingdir/signage_youtube_download

- title: Show Website
  shell: echo {{ website }} | $workingdir/signage_browser
  icon: "&#127758"
  arguments:
   - name: website
     title: Website Address
     type: ascii_identifier
     default: apple.com

- title: Stop Signage Services
  shell: $workingdir/signage_stop
  icon: "&#9211"
EOL
}

install_olivetin ()
{
echo cheking olivetin service
if test -f "/etc/systemd/system/OliveTin.service" ; then
 echo olivetin service exists
 echo removing olivetin service
 sudo systemctl stop OliveTin.service
 sudo systemctl disable OliveTin.service > /dev/null 2>&1
 sudo rm -f /etc/systemd/system/OliveTin.service
 sudo systemctl daemon-reload

 echo installing latest olivetin
 wget https://github.com/OliveTin/OliveTin/releases/download/2022-01-06/OliveTin_2022-01-06_linux_arm64.deb > /dev/null 2>&1
 sudo dpkg -i OliveTin_2022-01-06_linux_arm64.deb > /dev/null 2>&1

echo configuring olivetin
sudo mv /etc/OliveTin/config.yaml /etc/OliveTin/backup_$(date +'%d_%m_%Y_%I_%M').yaml
$(olivetin_config)

echo starting olivetin service
sudo systemctl start OliveTin.service
sudo systemctl enable OliveTin.service > /dev/null 2>&1
rm OliveTin_2022-01-06_linux_arm64.deb
else
 echo olivetin service does not exist
 echo installing latest olivetin
 wget https://github.com/OliveTin/OliveTin/releases/download/2022-01-06/OliveTin_2022-01-06_linux_arm64.deb > /dev/null 2>&1
 sudo dpkg -i OliveTin_2022-01-06_linux_arm64.deb > /dev/null 2>&1

echo configuring olivetin
sudo mv /etc/OliveTin/config.yaml /etc/OliveTin/backup_$(date +'%d_%m_%Y_%I_%M').yaml
$(olivetin_config)

echo starting olivetin service
sudo systemctl start OliveTin.service
sudo systemctl enable OliveTin.service > /dev/null 2>&1
rm OliveTin_2022-01-06_linux_arm64.deb
fi
}

install_olivetin
